# Cortex-R: Multi-MCP Agent App ü§ñüß†

## üöÄ Overview

**Cortex-R** is a reasoning-driven, multi-MCP (Model Context Protocol) agent app designed for controlled, effective LLM (Large Language Model) generation. It leverages:
- **Strategic prompt engineering** (conservative, exploratory, fallback, etc.)
- **Input/output validation heuristics** for safe, robust LLM calls
- **Multi-server orchestration** for tool-rich, modular, and scalable agentic workflows
- **Memory and context management** for stepwise, context-aware problem solving

## ‚ú® Features
- üß© **Multi-MCP Server Orchestration**: Math, document, web, and memory servers
- üõ°Ô∏è **Heuristic Input/Output Validation**: NSFW, length, format, and schema checks
- üß† **Strategic Prompting**: Conservative, parallel, sequential, and fallback plans
- üìö **RAG & Document Search**: FAISS-based semantic search over local and web docs
- üìù **Session Memory**: Date-structured, persistent memory for context and history
- üîß **Extensible Tooling**: Add new tools and servers with minimal code changes

## üì∫ Demo
[![Watch how Mecro works]](https://drive.google.com/file/d/1_tsH8mXZ0QiYa0FYXY87zwofZVDbzxts/view?usp=sharing)

## üêõ Bug Report
```bash
Previous Issues
- The decision layer could not access the outputs from the perception layer or the memory, limiting its ability to make informed decisions.
- Outputs from tools were not being saved to memory, making them unavailable for future queries or for the decision layer to utilize.

Improvements and Updated Workflow
- Memory Lookup First:
When a query is received, the system first checks if a relevant answer already exists in memory. This helps avoid redundant processing and speeds up response time for repeated or similar queries.
- Perception Layer Processing:
If the answer is not found in memory, the query is forwarded to the perception layer. The perception layer processes the query, possibly using external tools or models to generate an initial response or extract relevant information.
- Passing Context to Decision Layer:
Both the original query and the output from the perception layer are then sent to the decision layer. This ensures the decision layer has full context, including any new insights or data generated by the perception layer.
- Decision Making:
The decision layer evaluates the combined information (query + perception output) and determines the next steps. This may involve synthesizing a final answer, invoking additional tools, or requesting further clarification.
- Tool Output Handling and Memory Update:
If any tools are called during this process, their outputs are now saved to memory. This ensures that all new information is retained and can be accessed by both the perception and decision layers in future interactions.
```

## Heuristics Added
```bash
Input Validation Rules
- Length Validation (validate_input_length)
Enforces maximum length of 100,000 characters
Enforces minimum length of 3 characters
Automatically truncates overly long inputs with "[truncated]" marker

- URL Validation (validate_urls)
Checks URLs against maximum length of 2,048 characters
Validates URL format and structure
Auto-fixes common issues (e.g., adding "https://" to "www." URLs)
Ensures proper URL parsing with scheme and netloc

- Content Safety (validate_no_nsfw)
Screens for inappropriate or offensive content
Blocks inputs containing predefined NSFW terms
Maintains a customizable blocklist of inappropriate terms

- Email Format (validate_email_format)
Validates email address formatting
Auto-corrects common email domain typos:
"gmial.com" ‚Üí "gmail.com"
"yaho.com" ‚Üí "yahoo.com"
"outlock.com" ‚Üí "outlook.com"
"hotmial.com" ‚Üí "hotmail.com"

Output Validation Rules
- JSON Parsing (validate_json_parsable)
Extracts JSON from markdown code blocks
Fixes common JSON formatting issues:
Converts single quotes to double quotes
Adds quotes to unquoted keys
Provides detailed JSON parsing error messages

- Schema Validation (validate_required_fields)
Enforces required fields for different output types:
Tool calls: "name" and "args"
Perception: "selected_servers"
Plan: "steps"
Auto-fills missing required fields with sensible defaults

- Empty Value Detection (validate_empty_values)
Identifies empty or null values in JSON
Provides context-aware default values:
name fields ‚Üí "unnamed_item"
description fields ‚Üí "No description provided."
URL fields ‚Üí "https://example.com"
other fields ‚Üí "N/A"
Recursively checks nested objects and arrays

Integration Features
- Comprehensive Validation (apply_heuristics_to_llm_call)
Combines all input and output validations
Returns detailed validation results
Provides both original and fixed versions
Reports overall validation status

- Async Support (validate_and_fix_llm_interaction)
Asynchronous validation for agent loop integration
Automatic logging of validation issues
Returns fixed versions of both prompt and response

- Error Handling
All validation functions return tuples containing:
Validation status (boolean)
Error messages (if any)
Fixed/corrected version of the input/output
```

## New Queries
```bash
1. What is the square root of the sum of the squares of 3, 4, and 5?
2. Summarize this article for me https://netflixtechblog.com/foundation-model-for-personalized-recommendation-1a0bd8e02d39?source=collection_home---4------0-----------------------
3. What is the main theme of the book "To Kill a Mockingbird"?
4. What was Elon musk's vision for Tesla? Hint: Use document search
5. What was the dispute Tesla Motor was involved in 2013? Hint: Use document search
```

## üõ†Ô∏è How It Works
1. **Perception**: Extracts intent, entities, and relevant servers from user input
2. **Planning**: Selects a prompt strategy (conservative, parallel, sequential)
3. **Validation**: Applies heuristics to all LLM inputs/outputs
4. **Execution**: Runs tool calls via MCP servers, with fallback and memory
5. **Memory**: Stores and retrieves session context for better reasoning

---
